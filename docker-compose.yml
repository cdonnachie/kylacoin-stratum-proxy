services:
  kylacoin:
    build:
      context: .
      dockerfile: Dockerfile.kylacoin
    container_name: kylacoin-node
    restart: unless-stopped
    ports:
      - "${KCN_RPC_PORT:-5110}:${KCN_RPC_PORT:-5110}"
      - "${KCN_P2P_PORT:-5111}:${KCN_P2P_PORT:-5111}"
      - "28332:28332" # ZMQ hashblock
      - "28333:28333" # ZMQ rawblock
    volumes:
      - kylacoin-data:/home/kylacoin/.kylacoin
    environment:
      - KCN_RPC_USER=${KCN_RPC_USER}
      - KCN_RPC_PASS=${KCN_RPC_PASS}
      - KCN_RPC_PORT=${KCN_RPC_PORT:-5110}
      - KCN_P2P_PORT=${KCN_P2P_PORT:-5111}
      - KCN_ZMQ_PORT=${KCN_ZMQ_PORT:-28332}
      - KCN_ZMQ_RAW_PORT=${KCN_ZMQ_RAW_PORT:-28333}
    # Configuration is generated by entrypoint script from environment variables
    # No command needed - entrypoint handles everything
    networks:
      - crypto-net
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  lyncoin:
    build:
      context: .
      dockerfile: Dockerfile.lyncoin
    container_name: lyncoin-node
    restart: unless-stopped
    ports:
      - "${LCN_RPC_PORT:-5053}:${LCN_RPC_PORT:-5053}"
      - "${LCN_P2P_PORT:-5054}:${LCN_P2P_PORT:-5054}"
      - "28433:28433" # ZMQ hashblock
      - "28434:28434" # ZMQ rawblock
    volumes:
      - lyncoin-data:/home/lyncoin/.lyncoin
    environment:
      - LCN_RPC_USER=${LCN_RPC_USER}
      - LCN_RPC_PASS=${LCN_RPC_PASS}
      - LCN_RPC_PORT=${LCN_RPC_PORT:-5053}
      - LCN_P2P_PORT=${LCN_P2P_PORT:-5054}
      - LCN_ZMQ_PORT=${LCN_ZMQ_PORT:-28433}
      - LCN_ZMQ_RAW_PORT=${LCN_ZMQ_RAW_PORT:-28434}
    # Configuration is generated by entrypoint script from environment variables
    # No command needed - entrypoint handles everything
    networks:
      - crypto-net
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  stratum-proxy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kcn-lcn-proxy
    restart: unless-stopped
    ports:
      - "${STRATUM_PORT:-54321}:${STRATUM_PORT:-54321}"
      - "${DASHBOARD_PORT:-8080}:${DASHBOARD_PORT:-8080}"
    depends_on:
      kylacoin:
        condition: service_healthy
      lyncoin:
        condition: service_healthy
    environment:
      - KCN_RPC_HOST=kylacoin
      - KCN_RPC_PORT=${KCN_RPC_PORT:-5110}
      - KCN_RPC_USER=${KCN_RPC_USER}
      - KCN_RPC_PASS=${KCN_RPC_PASS}
      - LCN_RPC_HOST=lyncoin
      - LCN_RPC_PORT=${LCN_RPC_PORT:-5053}
      - LCN_RPC_USER=${LCN_RPC_USER}
      - LCN_RPC_PASS=${LCN_RPC_PASS}
      - LCN_WALLET_ADDRESS=${LCN_WALLET_ADDRESS}
      - STRATUM_PORT=${STRATUM_PORT:-54321}
      - TESTNET=${TESTNET:-false}
      - VERBOSE=${VERBOSE:-false}
      - SHOW_JOBS=${SHOW_JOBS:-false}
      - USE_EASIER_TARGET=${USE_EASIER_TARGET:-true}
      - DEBUG_SHARES=${DEBUG_SHARES:-false}
      - SHARE_DIFFICULTY_DIVISOR=${SHARE_DIFFICULTY_DIVISOR:-1.0}
      - PROXY_SIGNATURE=${PROXY_SIGNATURE:-/kyla-stratum-proxy/}
      - ENABLE_ZMQ=${ENABLE_ZMQ:-true}
      - KCN_ZMQ_ENDPOINT=${KCN_ZMQ_ENDPOINT:-tcp://kylacoin:28332}
      - LCN_ZMQ_ENDPOINT=${LCN_ZMQ_ENDPOINT:-tcp://lyncoin:28433}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - ENABLE_DASHBOARD=${ENABLE_DASHBOARD:-false}
      - DASHBOARD_PORT=${DASHBOARD_PORT:-8080}
      - ENABLE_DATABASE=${ENABLE_DATABASE:-false}
    command: ["/app/entrypoint.sh"]
    networks:
      - crypto-net
    volumes:
      - ./submit_history:/app/submit_history
      - ./data:/app/data
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import socket; s=socket.socket(); s.connect(('localhost', ${STRATUM_PORT:-54321})); s.close()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  crypto-net:
    driver: bridge

volumes:
  kylacoin-data:
    driver: local
  lyncoin-data:
    driver: local
