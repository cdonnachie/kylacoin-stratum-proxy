services:
  kylacoin:
    build:
      context: .
      dockerfile: Dockerfile.kylacoin
    container_name: kylacoin-node
    restart: unless-stopped
    ports:
      - "${KCN_RPC_PORT:-5110}:${KCN_RPC_PORT:-5110}"
      - "${KCN_P2P_PORT:-5111}:${KCN_P2P_PORT:-5111}"
      - "29332:29332" # ZMQ hashblock
      - "29333:29333" # ZMQ rawblock
    volumes:
      - kylacoin-data:/home/kylacoin/.kylacoin
    environment:
      - KCN_RPC_USER=${KCN_RPC_USER}
      - KCN_RPC_PASS=${KCN_RPC_PASS}
      - KCN_RPC_PORT=${KCN_RPC_PORT:-5110}
      - KCN_P2P_PORT=${KCN_P2P_PORT:-5111}
      - KCN_ZMQ_PORT=${KCN_ZMQ_PORT:-29332}
      - KCN_ZMQ_RAW_PORT=${KCN_ZMQ_RAW_PORT:-29333}
      # Bootstrap configuration
      - ENABLE_BOOTSTRAP=${ENABLE_BOOTSTRAP:-true}
      - BOOTSTRAP_MAX_AGE_DAYS=${BOOTSTRAP_MAX_AGE_DAYS:-7}
      - BOOTSTRAP_FORCE=${BOOTSTRAP_FORCE:-false}
      - BOOTSTRAP_VERIFY_CHECKSUM=${BOOTSTRAP_VERIFY_CHECKSUM:-true}
    # Configuration is generated by entrypoint script from environment variables
    # No command needed - entrypoint handles everything
    networks:
      - crypto-net
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  lyncoin:
    build:
      context: .
      dockerfile: Dockerfile.lyncoin
    container_name: lyncoin-node
    restart: unless-stopped
    ports:
      - "${LCN_RPC_PORT:-5053}:${LCN_RPC_PORT:-5053}"
      - "${LCN_P2P_PORT:-5054}:${LCN_P2P_PORT:-5054}"
      - "29433:29433" # ZMQ hashblock
      - "29434:29434" # ZMQ rawblock
    volumes:
      - lyncoin-data:/home/lyncoin/.lyncoin
    environment:
      - LCN_RPC_USER=${LCN_RPC_USER}
      - LCN_RPC_PASS=${LCN_RPC_PASS}
      - LCN_RPC_PORT=${LCN_RPC_PORT:-5053}
      - LCN_P2P_PORT=${LCN_P2P_PORT:-5054}
      - LCN_ZMQ_PORT=${LCN_ZMQ_PORT:-29433}
      - LCN_ZMQ_RAW_PORT=${LCN_ZMQ_RAW_PORT:-29434}
      # Bootstrap configuration
      - ENABLE_BOOTSTRAP=${ENABLE_BOOTSTRAP:-true}
      - BOOTSTRAP_MAX_AGE_DAYS=${BOOTSTRAP_MAX_AGE_DAYS:-7}
      - BOOTSTRAP_FORCE=${BOOTSTRAP_FORCE:-false}
      - BOOTSTRAP_VERIFY_CHECKSUM=${BOOTSTRAP_VERIFY_CHECKSUM:-true}
    # Configuration is generated by entrypoint script from environment variables
    # No command needed - entrypoint handles everything
    networks:
      - crypto-net
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  stratum-proxy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kcn-lcn-proxy
    restart: unless-stopped
    ports:
      - "${STRATUM_PORT:-54321}:${STRATUM_PORT:-54321}"
      - "${DASHBOARD_PORT:-8080}:${DASHBOARD_PORT:-8080}"
    depends_on:
      kylacoin:
        condition: service_healthy
    environment:
      - KCN_RPC_HOST=kylacoin
      - KCN_RPC_PORT=${KCN_RPC_PORT:-5110}
      - KCN_RPC_USER=${KCN_RPC_USER}
      - KCN_RPC_PASS=${KCN_RPC_PASS}
      - LCN_RPC_HOST=lyncoin
      - LCN_RPC_PORT=${LCN_RPC_PORT:-5053}
      - LCN_RPC_USER=${LCN_RPC_USER}
      - LCN_RPC_PASS=${LCN_RPC_PASS}
      - LCN_WALLET_ADDRESS=${LCN_WALLET_ADDRESS}
      - STRATUM_PORT=${STRATUM_PORT:-54321}
      - TESTNET=${TESTNET:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - SHOW_JOBS=${SHOW_JOBS:-false}
      - USE_EASIER_TARGET=${USE_EASIER_TARGET:-true}
      - SHARE_DIFFICULTY_DIVISOR=${SHARE_DIFFICULTY_DIVISOR:-1.0}
      - PROXY_SIGNATURE=${PROXY_SIGNATURE:-/kyla-stratum-proxy/}
      - ENABLE_ZMQ=${ENABLE_ZMQ:-true}
      - KCN_ZMQ_ENDPOINT=${KCN_ZMQ_ENDPOINT:-tcp://kylacoin:28332}
      - LCN_ZMQ_ENDPOINT=${LCN_ZMQ_ENDPOINT:-tcp://lyncoin:28433}
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - ENABLE_DASHBOARD=${ENABLE_DASHBOARD:-false}
      - DASHBOARD_PORT=${DASHBOARD_PORT:-8080}
      - ENABLE_DATABASE=${ENABLE_DATABASE:-false}
      - ENABLE_VARDIFF=${ENABLE_VARDIFF:-false}
      - VARDIFF_TARGET_SHARE_TIME=${VARDIFF_TARGET_SHARE_TIME:-15.0}
      - VARDIFF_MIN_DIFFICULTY=${VARDIFF_MIN_DIFFICULTY:-0.00001}
      - VARDIFF_MAX_DIFFICULTY=${VARDIFF_MAX_DIFFICULTY:-0.1}
      - VARDIFF_RETARGET_SHARES=${VARDIFF_RETARGET_SHARES:-20}
      - VARDIFF_RETARGET_TIME=${VARDIFF_RETARGET_TIME:-300.0}
      - VARDIFF_UP_STEP=${VARDIFF_UP_STEP:-2.0}
      - VARDIFF_DOWN_STEP=${VARDIFF_DOWN_STEP:-0.5}
      - VARDIFF_EMA_ALPHA=${VARDIFF_EMA_ALPHA:-0.3}
      - VARDIFF_INACTIVITY_LOWER=${VARDIFF_INACTIVITY_LOWER:-90.0}
      - VARDIFF_INACTIVITY_MULTIPLES=${VARDIFF_INACTIVITY_MULTIPLES:-6.0}
      - VARDIFF_INACTIVITY_DROP_FACTOR=${VARDIFF_INACTIVITY_DROP_FACTOR:-0.5}
      - VARDIFF_STATE_PATH=${VARDIFF_STATE_PATH:-data/vardiff_state.json}
      - VARDIFF_WARM_START_MINUTES=${VARDIFF_WARM_START_MINUTES:-60}
      - VARDIFF_CHAIN_HEADROOM=${VARDIFF_CHAIN_HEADROOM:-0.9}
    command: ["/app/entrypoint.sh"]
    networks:
      - crypto-net
    volumes:
      - ./submit_history:/app/submit_history
      - ./data:/app/data
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import socket; s=socket.socket(); s.connect(('localhost', ${STRATUM_PORT:-54321})); s.close()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  crypto-net:
    driver: bridge

volumes:
  kylacoin-data:
    driver: local
  lyncoin-data:
    driver: local
