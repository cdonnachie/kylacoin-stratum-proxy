services:
  kylacoin:
    build:
      context: .
      dockerfile: Dockerfile.kylacoin
    container_name: kylacoin-node
    restart: unless-stopped
    ports:
      - "${KCN_RPC_PORT:-5110}:${KCN_RPC_PORT:-5110}"
      - "${KCN_P2P_PORT:-5111}:${KCN_P2P_PORT:-5111}"
    volumes:
      - kylacoin-data:/home/kylacoin/.kylacoin
    environment:
      - KCN_RPC_USER=${KCN_RPC_USER}
      - KCN_RPC_PASS=${KCN_RPC_PASS}
      - KCN_RPC_PORT=${KCN_RPC_PORT:-5110}
      - KCN_P2P_PORT=${KCN_P2P_PORT:-5111}
    # Configuration is generated by entrypoint script from environment variables
    # No command needed - entrypoint handles everything
    networks:
      - crypto-net
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  lyncoin:
    build:
      context: .
      dockerfile: Dockerfile.lyncoin
    container_name: lyncoin-node
    restart: unless-stopped
    ports:
      - "${LCN_RPC_PORT:-5053}:${LCN_RPC_PORT:-5053}"
      - "${LCN_P2P_PORT:-5054}:${LCN_P2P_PORT:-5054}"
    volumes:
      - lyncoin-data:/home/lyncoin/.lyncoin
    environment:
      - LCN_RPC_USER=${LCN_RPC_USER}
      - LCN_RPC_PASS=${LCN_RPC_PASS}
      - LCN_RPC_PORT=${LCN_RPC_PORT:-5053}
      - LCN_P2P_PORT=${LCN_P2P_PORT:-5054}
    # Configuration is generated by entrypoint script from environment variables
    # No command needed - entrypoint handles everything
    networks:
      - crypto-net
    healthcheck:
      test: ["CMD", "/usr/local/bin/health-check.sh"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  stratum-proxy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: kcn-lcn-proxy
    restart: unless-stopped
    ports:
      - "${STRATUM_PORT:-54321}:${STRATUM_PORT:-54321}"
    depends_on:
      kylacoin:
        condition: service_healthy
      lyncoin:
        condition: service_healthy
    environment:
      - KCN_RPC_HOST=kylacoin
      - KCN_RPC_PORT=${KCN_RPC_PORT:-5110}
      - KCN_RPC_USER=${KCN_RPC_USER}
      - KCN_RPC_PASS=${KCN_RPC_PASS}
      - LCN_RPC_HOST=lyncoin
      - LCN_RPC_PORT=${LCN_RPC_PORT:-5053}
      - LCN_RPC_USER=${LCN_RPC_USER}
      - LCN_RPC_PASS=${LCN_RPC_PASS}
      - LCN_WALLET_ADDRESS=${LCN_WALLET_ADDRESS}
      - STRATUM_PORT=${STRATUM_PORT:-54321}
      - TESTNET=${TESTNET:-false}
      - VERBOSE=${VERBOSE:-false}
      - SHOW_JOBS=${SHOW_JOBS:-false}
      - USE_EASIER_TARGET=${USE_EASIER_TARGET:-false}
      - PROXY_SIGNATURE=${PROXY_SIGNATURE:-/kyla-stratum-proxy/}
    command: ["/app/entrypoint.sh"]
    networks:
      - crypto-net
    volumes:
      - ./submit_history:/app/submit_history
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import socket; s=socket.socket(); s.connect(('localhost', ${STRATUM_PORT:-54321})); s.close()",
        ]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  crypto-net:
    driver: bridge

volumes:
  kylacoin-data:
    driver: local
  lyncoin-data:
    driver: local
